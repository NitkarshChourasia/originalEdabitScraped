//This script is for python and not javascriptssssss

//Global settings:-
function print(context) {
  console.log(context);
}

var current_program_title = null;
var program_number = 1; //Used in file title printing
var current_program_number = 1; //Used to track the number of the element in the current list
var current_difficulty = "Very Easy";
var instructions = null;
var resources = null;
var myfile = null;
var current_program_difficulty = "Very Easy";
var diff_menu_items = {};
for (let i of document.getElementsByClassName("menu transition")[1].children){
  diff_menu_items[(i.innerText).toString()] = i;
}

setDifficulty();

function updateDifficulty() {
  let programs = document.getElementsByClassName("item no-highlight");
  current_program_difficulty = programs[current_program_number].children[1].children[3].innerText;
  if(current_program_difficulty != current_difficulty) {
    current_difficulty = current_program_difficulty;
    //print(current_difficulty + " " + current_program_number);
    current_program_number = 0;
  }
}

function setDifficulty() {
  if (document.getElementsByClassName("item no-highlight").length > 0){
  	selectTheProgram();
  }
  else {
    setTimeout(setDifficulty, 100);
  }
}

function selectTheProgram() {
  let programs = document.getElementsByClassName("item no-highlight");
  if(programs.length > current_program_number) {
    //print(Date());
    startFileExtraction();
  }
  else {
    document.getElementsByClassName("ui fluid button")[0].click();
    setTimeout(selectTheProgram, 700);
  }
}

//These functions are temporary
function startFileExtraction() {
  let temp = current_program_number;
  //print(current_program_difficulty);
  updateDifficulty();
  //console.log("Program going to start");
  setTimeout(waitForFS, 50, temp);
}

function waitForFS(temp) {
  document.getElementsByClassName("item no-highlight")[temp].click();
  setTimeout(startFileExtRFunc, 2000);
}

function startFileExtRFunc() {
  if (document.getElementsByClassName("grey-segment code-area instructions").length > 0) {
    setTimeout(waitForInst, 700);
  }
  else {
    //console.log("No it is not");
    setTimeout(startFileExtRFunc, 300);
  }
}

function waitForInst() {
  instructions = extractTheContent1();
  //setTimoutloopstarts
  document.getElementsByClassName("rc-tabs-tab")[2].click();
  setTimeout(waitForRes, 300);
}

function extractTheContent1() {
  let problemTitle = document.getElementsByClassName("content");
  current_program_title = problemTitle[0].innerText;// Expected to return the problem title and is tested
  print(current_program_title);
  let labelsEle = (document.getElementsByClassName("sub header no-highlight"))[1];

  let labels = [];

  for (let i of labelsEle.children) {
    labels.push(i.innerText);
  }
    //Examples
  let mainDivEle = document.getElementsByClassName("grey-segment code-area instructions")[0].children[1];

  let mainContent = "\n##" + current_program_title + "\n\n";
  for (let i of mainDivEle.children) {
    let p_string = "";
    if(i.tagName == "P") {
      for (let j of i.children){
        p_string += j.innerText;
      }

    }
    else if(i.tagName == "PRE"){
      p_string += "___\n"  + i.innerText + "\n_____\n" ;
    }

    else if(i.tagName == "H3"){
      p_string += "\n\n[" + i.innerText + "]\n";
    }

    else if(i.tagName == "UL"){
      p_string += "___\n"
      for (let j of i.children) {
        p_string += "*) " + j.innerText + "\n";
      }
      p_string += "___\n"
    }
    mainContent += p_string + "\n";
  }

  mainContent += "\n\n";
  labels.forEach((item) => {
    mainContent += "[" + item + "] ";
  })

  return mainContent;
}

function extractTheContent2() {
  let mainContent = "\n\n\n\n-------------------------------------------------------------------\n[Resources]\n";

  let mainDivEle = (document.getElementsByClassName("ui comments"))[0].children;

  for (let i of mainDivEle) {
    let p_string = "";

    p_string += "_________\n";
    p_string += i.children[0].children[0].children[0].children[0].children[0].innerText + "\n";

    p_string += i.children[0].children[0].children[0].children[0].children[0].getAttribute("href") + "\n";

    p_string += i.children[0].children[0].children[0].children[2].innerText + "\n";

    p_string += "_________\n";
    mainContent += p_string;
  }
  return mainContent;
}

function waitForRes() {
  if (document.getElementById("Resources") != null) {
    resources = extractTheContent2();
    myfile = "/" + instructions + resources + "/ \n// Your code should go here:\n\n";
    let content = [myfile];
    let bl = new Blob(content, {type: "text/py"});
    let aaaa = document.createElement("a");
    aaaa.href = URL.createObjectURL(bl);
    aaaa.download = "[" + program_number.toString() + "] " + cleanTitle(current_program_title) + " [" + getTheShortForm(current_program_difficulty) + "]" + ".java";
    aaaa.hidden = true;
    document.body.appendChild(aaaa);
    aaaa.click();
    setTimeout(returnToMenu, 500);
  }
  else {
    setTimeout(waitForRes, 1000);
  }
}

function returnToMenu() {
  document.getElementsByClassName("link item navbar-item")[1].click();
  current_program_number += 1;
  program_number += 1;
  waitForItems(false);
}

function cleanTitle(title) {
  let regex = /[/\:,."<>|?*]/g;
  let new_title = title.replaceAll(regex, "_");
  regex = /_{2,}/g
  new_title = new_title.replaceAll(regex, "");
  return new_title;
}

function getTheShortForm(phrase) {
  if(phrase == "Expert") {
    return "Ex";
  }
  let words = phrase.split(" ");
  let shortForm = "";
  for (let i of words) {
    shortForm += i.slice(0,1);
  }
  return shortForm;
}

function waitForItems() {
  if (document.getElementsByClassName("item no-highlight").length > 0){
    instructions = null;
    for (let i of document.getElementsByClassName("menu transition")[1].children){
      diff_menu_items[(i.innerText).toString()] = i;
    }
  	diff_menu_items[current_difficulty].click();
    setDifficulty();
  }
  else {
    setTimeout(waitForItems, 100);
  }
}

///There are a lot of functions here that can be shortened in terms of code.
///Like we can actually make a wait function that waits for a specific condition to be met before executing a callback function.
/// Just a prototype of loading function
/*function domLoop(condition, func, timer) {
  if(condition){
    func();
  }
  else {
    setTimeout(domLoop, timer, condition, func, timer);
  }
}
*/
